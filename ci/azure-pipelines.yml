variables:
  - group: terraform-variables
  - name: organization
    value: $(System.CollectionUri)
  - name: project
    value: $(System.TeamProject)
  - name: repositoryId
    value: $(Build.Repository.ID)
  - name: pullRequestId
    value: $(System.PullRequest.PullRequestId)

pr:
  branches:
    include:
      - 'develop'

stages:
  - stage: Dev
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '14.x'
            displayName: 'Install Node.js'
          - script: |
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
              sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
              sudo apt-get update && sudo apt-get install terraform
            displayName: 'Install Terraform'
          - script: |
              cd $(Build.SourcesDirectory)/infrastructure
              chmod +x ./deploy.sh
              ./deploy.sh dev
            displayName: 'Deploy to Dev'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
          - script: |
              cd $(Build.SourcesDirectory)/test
              npm install
              npm run test:dev
            displayName: 'Run Dev infrastructure tests'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
          - script: |
              cd $(Build.SourcesDirectory)/infrastructure
              chmod +x ./destroy.sh
              ./destroy.sh dev
            displayName: 'Destroy Dev'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            condition: succeededOrFailed()
  - stage: QA
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '14.x'
            displayName: 'Install Node.js'
          - script: |
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
              sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
              sudo apt-get update && sudo apt-get install terraform
            displayName: 'Install Terraform'
          - script: |
              cd $(Build.SourcesDirectory)/infrastructure
              chmod +x ./deploy.sh
              ./deploy.sh qa
            displayName: 'Deploy to QA'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
          - script: |
              cd $(Build.SourcesDirectory)/test
              npm install
              npm run test:qa
            displayName: 'Run QA infrastructure tests'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
          - script: |
              cd $(Build.SourcesDirectory)/infrastructure
              chmod +x ./destroy.sh
              ./destroy.sh qa
            displayName: 'Destroy QA'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            condition: succeededOrFailed()
  - stage: Merge_PR
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          - script: |
              cd $(Build.SourcesDirectory)/infrastructure
              ./merge-pr.sh $(organization) $(project) $(repositoryId) $(repositoryId) $(MERGE_PR_TOKEN)
            displayName: 'Merge PR'
            continueOnError: true