variables:
  - name: ARM_CLIENT_ID
    value: $(azure-connection.ServicePrincipalId)
  - name: ARM_CLIENT_SECRET
    value: $(azure-connection.ServicePrincipalKey)
  - name: ARM_SUBSCRIPTION_ID
    value: $(azure-connection.SubscriptionId)
  - name: ARM_TENANT_ID
    value: $(azure-connection.TenantId)

pr:
  branches:
    include:
      - 'develop'

stages:
  - stage: Dev
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '14.x'
            displayName: 'Install Node.js'
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: 'echo "Logged into Azure CLI"'
          - script: |
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
              sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
              sudo apt-get update && sudo apt-get install terraform
            displayName: 'Install Terraform'
          - script: |
              echo "==================="
              echo $ARM_CLIENT_ID
              echo $ARM_SUBSCRIPTION_ID
              echo $ARM_TENANT_ID
              echo "==================="
              cd ./infrastructure
              chmod +x ./deploy.sh
              ./deploy.sh dev
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            displayName: 'Deploy to Dev'
          - script: |
              cd ../test
              npm install
              npm run test:dev
            displayName: 'Run Dev infrastructure tests'
          - script: |
              cd ../infrastructure
              chmod +x ./destroy.sh
              ./destroy.sh dev
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            displayName: 'Destroy Dev'
  - stage: QA
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '14.x'
            displayName: 'Install Node.js'
          - script: |
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
              sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
              sudo apt-get update && sudo apt-get install terraform
            displayName: 'Install Terraform'
          - script: |
              cd ./infrastructure
              chmod +x ./deploy.sh
              ./deploy.sh qa
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            displayName: 'Deploy to QA'
          - script: |
              cd ../test
              npm install
              npm run test:qa
            displayName: 'Run QA infrastructure tests'
          - script: |
              cd ../infrastructure
              chmod +x ./destroy.sh
              ./destroy.sh qa
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
            displayName: 'Destroy QA'
